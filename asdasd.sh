# 1) Definição do upstream (load‑balancer round‑robin) upstream hub_backend { server 127.0.0.1:8000 weight=1 max_fails=3 fail_timeout=30s; keepalive 16; } # 2) Zone de rate limiting: até 10.000 requisições/s por IP limit_req_zone $binary_remote_addr zone=api_zone:10m rate=10000r/s; server { # 3) HTTP → HTTPS if ($host = api.debt.com.br) { return 301 https://$host$request_uri; } listen 80; server_name api.debt.com.br; return 301 https://$host$request_uri; } server { listen 443 ssl http2; server_name api.debt.com.br; # 4) Certificados (letsencrypt) ssl_certificate /etc/letsencrypt/live/api.debt.com.br/fullchain.pem; # managed by Certbot ssl_certificate_key /etc/letsencrypt/live/api.debt.com.br/privkey.pem; # managed by Certbot include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot # 5) Segurança básica de honeypot location ~* /(actuator|\.env|admin|wp-admin|wp-login\.php|phpmyadmin) { access_log /var/log/nginx/honeypot-access.log; return 403; } # 6) Rate limiting limit_req zone=api_zone burst=2000 nodelay; # 7) Proxy / load‑balancer location /report-sms/ { proxy_pass http://127.0.0.1:5000; proxy_http_version 1.1; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_set_header Connection ""; proxy_connect_timeout 5s; proxy_send_timeout 60s; proxy_read_timeout 60s; client_max_body_size 20M; } location /download-report-sms/ { proxy_pass http://127.0.0.1:5000; proxy_http_version 1.1; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_set_header Connection ""; proxy_connect_timeout 5s; proxy_send_timeout 60s; proxy_read_timeout 60s; client_max_body_size 50M; } location / { proxy_pass http://hub_backend; proxy_http_version 1.1; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_set_header Connection ""; # timeouts proxy_connect_timeout 5s; proxy_send_timeout 30s; proxy_read_timeout 30s; # buffers proxy_buffer_size 128k; proxy_buffers 4 256k; proxy_busy_buffers_size 256k; proxy_temp_file_write_size 256k; # tamanho máximo de upload JSON, etc. client_max_body_size 20M; } # 8) Cabeçalhos de segurança adicionais add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always; add_header X-Content-Type-Options "nosniff" always; add_header X-Frame-Options "DENY" always; add_header Referrer-Policy "no-referrer-when-downgrade" always; # Content Security Policy básico; ajuste conforme sua API add_header Content-Security-Policy "default-src 'none'; connect-src 'self'; script-src 'none'; style-src 'none'; object-src 'none';" always; # 9) Gzip gzip on; gzip_types application/json text/plain text/css application/javascript; gzip_min_length 256; gzip_proxied any; }